<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <title>Preview â€¢ Pico CSS</title>
    <meta name="description" content="A pure HTML example, without dependencies.">

    <!-- Pico.css -->
    <link rel="stylesheet" href="pico.min.css">
    <link rel="stylesheet" href="widgets/navbar.css">
    <link rel="stylesheet" href="widgets/display-overview.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<!-- Load the navigation bar -->
<div id="navbar"></div>
<script src="widgets/navbar.js"></script>

<div id="body-content">
    <h2>Connected Displays</h2>

    <div class="grid">
        <div id="display-overview-panel" class="grid"></div>
    </div>
</div>

<script>
    var gateway = `ws://${window.location.hostname}/ws`;
    var websocket;

    function initWebSocket() {
        console.log("initWebSocket");
        websocket = new WebSocket(gateway);
        websocket.onmessage = onMessage;
        websocket.onopen = onOpen
    }

    async function onMessage(event) {
        var data = JSON.parse(event.data);
        console.log(data);

        switch(data.type) {
            case "DISPLAY_STATI":
                var htmlDisplays = document.getElementById("display-overview-panel").children;
                var jsonDisplays = data.displays;

                // Iterate through all json displays
                for(let i = 0; i < jsonDisplays.length; i++) {
                    // Then iterate through all html displays
                    let htmlDisplay = null
                    let jsonDisplay = jsonDisplays[i]
                    for(let j = 0; j < htmlDisplays.length; j++) {
                        // Does the UUID match?
                        console.log(htmlDisplays[j].querySelector("#hw-uuid").innerHTML);
                        console.log(sonDisplay.uuid);
                        if(htmlDisplays[j].querySelector("#hw-uuid").innerHTML == jsonDisplay.uuid) {
                            htmlDisplay = htmlDisplays[j]
                            break;
                        }
                    }

                    // Do we need to create a new entry?
                    if (htmlDisplay == null) {
                        await fetch('widgets/display-overview.html')
                        .then(response => response.text())
                        .then(text => {
                            // Add the child
                            let displayPanel = document.getElementById('display-overview-panel');
                            displayPanel.innerHTML += text;

                            // Then find it
                            for(let l = 0; l < displayPanel.children.length; l++) {
                                if(displayPanel.children[l].id == "display-div") {
                                    // Alter its ID
                                    displayPanel.children[l].id == "display" + l.toString()  + "-div";

                                    // Save it
                                    htmlDisplay = displayPanel.children[l];

                                    // Connect to the restart button
                                    let btn = htmlDisplay.querySelector("#restart-button")
                                    btn.addEventListener('click', (event) => {
                                        try {
                                            // Alter the label
                                            htmlDisplay.querySelector("#connected").innerHTML = "Restarting"
                                            htmlDisplay.querySelector("#connected").style.color = "#FFBF00";

                                            // Request the restart
                                            fetch('/api/post/restart_display', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ id: htmlDisplay.querySelector("#com-id").innerHTML
                                                })
                                            });
                                        } catch (error) {
                                            console.error("Couldn't restart display: ", error);
                                        }
                                    })

                                    break;
                                }
                            }
                        });
                    }

                    // Update its values
                    htmlDisplay.querySelector("#connected").innerHTML = jsonDisplay.connected == true ? "Connected" : "Disconnected";
                    htmlDisplay.querySelector("#connected").style.color = jsonDisplay.connected == true ? "#008000" : "#F54927";
                    if(jsonDisplay.firmware != null) {
                        htmlDisplay.querySelector("#firmware").innerHTML = jsonDisplay.firmware;
                    } else {
                        htmlDisplay.querySelector("#firmware").innerHTML = "UNKNOWN";
                    }
                    if(jsonDisplay.uuid != null) {
                        htmlDisplay.querySelector("#hw-uuid").innerHTML = jsonDisplay.uuid;
                    }
                    htmlDisplay.querySelector("#com-id").innerHTML = jsonDisplay.com_id;
                    if(jsonDisplay.wifi != null) {
                        htmlDisplay.querySelector("#wifi").innerHTML = jsonDisplay.wifi;
                    }
                }
                break;
        }
    }

    function onOpen() {
        // Send a request on startup to get the initial data
        fetch('/api/get/initial_data');
    }

    window.addEventListener('load', initWebSocket);
</script>

</body>
</html>